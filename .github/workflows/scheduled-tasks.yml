# =============================================================================
# HZ Navigator - Scheduled Tasks
# =============================================================================
# Automated scheduled tasks for maintenance and monitoring
# =============================================================================

name: Scheduled Tasks

on:
  schedule:
    # Daily at 2 AM UTC - Cleanup and maintenance
    - cron: '0 2 * * *'
    # Weekly on Sunday at 3 AM UTC - Security scan
    - cron: '0 3 * * 0'
    # Monthly on 1st at 4 AM UTC - Dependency updates check
    - cron: '0 4 1 * *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - cleanup
          - security-scan
          - dependency-check
          - all

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Cleanup Old Resources
  # ===========================================================================
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || inputs.task == 'cleanup' || inputs.task == 'all'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup old ECR images
        run: |
          echo "ðŸ§¹ Cleaning up old ECR images..."
          
          for ENV in staging production; do
            REPO="hz-navigator-${ENV}-backend"
            
            # Get images older than 30 days (keep last 10)
            OLD_IMAGES=$(aws ecr describe-images \
              --repository-name $REPO \
              --query 'imageDetails[?imagePushedAt<`'$(date -d '30 days ago' -Iseconds)'`].imageDigest' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$OLD_IMAGES" ]; then
              echo "Deleting old images from $REPO..."
              # Keep implementation simple - just list what would be deleted
              echo "$OLD_IMAGES" | head -20
            fi
          done

      - name: Cleanup old ECS task definitions
        run: |
          echo "ðŸ§¹ Cleaning up old ECS task definitions..."
          
          for ENV in staging production; do
            FAMILY="hz-navigator-${ENV}-backend"
            
            # Deregister task definitions older than revision 10
            TASK_DEFS=$(aws ecs list-task-definitions \
              --family-prefix $FAMILY \
              --status ACTIVE \
              --sort ASC \
              --query 'taskDefinitionArns[:-3]' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$TASK_DEFS" ]; then
              echo "Would deregister: $TASK_DEFS"
            fi
          done

      - name: Cleanup old CloudWatch logs
        run: |
          echo "ðŸ§¹ Cleaning up old CloudWatch log groups..."
          
          # List log groups with no recent activity
          aws logs describe-log-groups \
            --query 'logGroups[?storedBytes==`0`].logGroupName' \
            --output text | head -10

      - name: Cleanup old S3 backups
        run: |
          echo "ðŸ§¹ Cleaning up old S3 backups..."
          
          # List backups older than 30 days
          for BUCKET in "${{ secrets.STAGING_S3_BUCKET }}-backups" "${{ secrets.PRODUCTION_S3_BUCKET }}-backups"; do
            echo "Checking $BUCKET..."
            aws s3 ls s3://$BUCKET/ 2>/dev/null | head -5 || echo "Bucket not found"
          done

  # ===========================================================================
  # Security Scan
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * 0' || inputs.task == 'security-scan' || inputs.task == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          output: 'trivy-results.txt'

      - name: Check for critical vulnerabilities
        id: trivy
        run: |
          CRITICAL=$(grep -c "CRITICAL" trivy-results.txt || echo "0")
          HIGH=$(grep -c "HIGH" trivy-results.txt || echo "0")
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          
          cat trivy-results.txt

      - name: Run npm audit (backend)
        working-directory: backend
        continue-on-error: true
        run: |
          npm ci
          npm audit --audit-level=high > ../backend-audit.txt 2>&1 || true
          cat ../backend-audit.txt

      - name: Run npm audit (frontend)
        working-directory: frontend
        continue-on-error: true
        run: |
          npm ci
          npm audit --audit-level=high > ../frontend-audit.txt 2>&1 || true
          cat ../frontend-audit.txt

      - name: Create security report
        run: |
          echo "# Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-report.md
          echo "" >> security-report.md
          echo "## Trivy Scan Results" >> security-report.md
          echo "- Critical: ${{ steps.trivy.outputs.critical }}" >> security-report.md
          echo "- High: ${{ steps.trivy.outputs.high }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Full Report" >> security-report.md
          echo '```' >> security-report.md
          cat trivy-results.txt >> security-report.md
          echo '```' >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_number }}
          path: |
            security-report.md
            trivy-results.txt
            backend-audit.txt
            frontend-audit.txt
          retention-days: 90

      - name: Notify on critical vulnerabilities
        if: steps.trivy.outputs.critical > 0
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ðŸš¨ Critical vulnerabilities detected!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Security Scan Alert*\n\nCritical vulnerabilities found: ${{ steps.trivy.outputs.critical }}\nHigh vulnerabilities found: ${{ steps.trivy.outputs.high }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Report>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================================================
  # Dependency Check
  # ===========================================================================
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 4 1 * *' || inputs.task == 'dependency-check' || inputs.task == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check backend dependencies
        working-directory: backend
        run: |
          npm ci
          echo "# Backend Dependency Updates" > ../dependency-report.md
          echo "" >> ../dependency-report.md
          npm outdated >> ../dependency-report.md 2>&1 || true

      - name: Check frontend dependencies
        working-directory: frontend
        run: |
          npm ci
          echo "" >> ../dependency-report.md
          echo "# Frontend Dependency Updates" >> ../dependency-report.md
          echo "" >> ../dependency-report.md
          npm outdated >> ../dependency-report.md 2>&1 || true

      - name: Check e2e dependencies
        working-directory: e2e
        run: |
          npm ci
          echo "" >> ../dependency-report.md
          echo "# E2E Dependency Updates" >> ../dependency-report.md
          echo "" >> ../dependency-report.md
          npm outdated >> ../dependency-report.md 2>&1 || true

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ github.run_number }}
          path: dependency-report.md
          retention-days: 30

      - name: Create issue for major updates
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-report.md', 'utf8');
            
            // Check if there are major updates
            if (report.includes('MAJOR')) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ“¦ Monthly Dependency Update Report',
                body: `## Dependency Update Report\n\n${report}\n\n_Generated on ${new Date().toISOString()}_`,
                labels: ['dependencies', 'maintenance']
              });
            }

